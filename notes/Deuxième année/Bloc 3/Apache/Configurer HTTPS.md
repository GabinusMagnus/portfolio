# Configurer HTTPS

- générer les clés

- générer un certificat

# Prérequis

Avant de générer les certificats SSL, le module ssl d'apache doit être activé.

`a2enmod ssl`

Cependant, cela ne fait qu'activer le support du https. Pour rediriger les requêtes http en https, on doit ajouter au fichier de configuration du site sécurisé (dans `/etc/apache2/sites-available/`) :

```bash
<VirtualHost *:80>
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^/?(.*)
</Virtualhost>
```

Pour que ces dernières lignes soient effectives, on active le module rewrite d'Apache : `a2enmod rewrite`

## Méthode longue :

| serveur web : 172.16.0.10                                                                                                                | CA : 172.16.0.20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ---------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                                                                                          | /etc/ssl/openssl/cnf:<br/>[ CA_default ] <br/>dir = /etc/ssl/sodecaf # Where everything is kept <br/>certs = $dir/certs # Where the issued certs are kept <br/>crl_dir = $dir/crl # Where the issued crl are kept <br/>database = $dir/index.txt # database index file ... <br/>new_certs_dir = $dir/newcerts # default place for new certs. <br/>certificate = $dir/certs/cacert.pem # The CA certificate <br/>serial = $dir/serial # The current serial number ... <br/>crl = $dir/crl.pem # The current CRL <br/>private_key = $dir/private/cakey.pem # The private key* |
|                                                                                                                                          | création des dossiers et des fichiers : `mkdir /etc/ssl/sodecaf mkdir /etc/ssl/sodecaf/certs mkdir /etc/ssl/sodecaf/crl mkdir /etc/ssl/sodecaf/newcerts mkdir /etc/ssl/sodecaf/private   touch /etc/ssl/sodecaf/index.txt echo 01 > /etc/ssl/sodecaf/serial`                                                                                                                                                                                                                                                                                                                |
|                                                                                                                                          | génération de la clé privée de CA :<br>`openssl genrsa -des3 -out /etc/ssl/sodecaf/private/cakey.pem 4096`                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                                                                                                                          | Génération du certificat de CA : `openssl req -new -x509 -days 365 -key /etc/ssl/sodecaf/private/cakey.pem -out /etc/ssl/sodecaf/certs/cacert.pem`                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Génération de la clé privée : `openssl genrsa -out /etc/ssl/private/srvwebkey.pem 4096`                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Création du fichier de demande de certificat : `openssl req -new -key /etc/ssl/private/srvwebkey.pem -out /etc/ssl/certs/srvweb_dem.pem` |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                          | production du certificat signé par l'autorité de certification : `openssl ca -policy policy_anything -out /etc/ssl/sodecaf/certs/servwebcert.pem -infiles /home/etudiant/srvweb_dem.pem`                                                                                                                                                                                                                                                                                                                                                                                    |
|                                                                                                                                          | Envoie du certificat au serveur web : `scp servwebcert.pem etudiant@172.16.0.10:/home/etudiant`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `mv /home/etudiant/servwebcert.pem /etc/ssl/certs/`                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

On peut aussi auto-signer notre certificat.

```bash
/etc/ssl/openssl/cnf:
[ CA_default ] 
dir = /etc/ssl/sodecaf # Where everything is kept 
certs = $dir/certs # Where the issued certs are kept 
crl_dir = $dir/crl # Where the issued crl are kept 
database = $dir/index.txt # database index file ... 
new_certs_dir = $dir/newcerts # default place for new certs. 
certificate = $dir/certs/cacert.pem # The CA certificate 
serial = $dir/serial # The current serial number ... 
crl = $dir/crl.pem # The current CRL 
private_key = $dir/private/cakey.pem # The private key
```
